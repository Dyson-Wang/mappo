'''
each list contains parameters of performing inference at a special point
    0-intermediate data size: bits
    1-compression rate
    2-front time: s
    3-front power: w
    4-front energy: j
'''

data = [[[3 * 224 * 224 * 8, 1, 0, 0, 0],  # vgg11
         [64 * 112 * 112 * 32, 128, 0.015589, 2.204, 0.034358],
         [128 * 56 * 56 * 32, 128, 0.045, 2.6344, 0.118548],
         [256 * 28 * 28 * 32, 128, 0.100595, 2.8618, 0.287883],
         [512 * 14 * 14 * 32, 128, 0.136817, 3.0338, 0.415075],
         [0, 1, 0.1893, 2.5795, 0.488299]],
        [[3 * 224 * 224 * 8, 1, 0, 0, 0],  # resnet18
         [64 * 56 * 56 * 32, 64, 0.004359, 2.2885, 0.009976],
         [128 * 28 * 28 * 32, 64, 0.01647, 2.6328, 0.043362],
         [256 * 14 * 14 * 32, 64, 0.025477, 2.8815, 0.073412],
         [512 * 7 * 7 * 32, 32, 0.03678, 3.013, 0.110818],
         [0, 1, 0.045887, 2.1454, 0.098446]],
        [[3 * 224 * 224 * 8, 1, 0, 0, 0],  # resnet152
         [64 * 112 * 112 * 64, 32, 0.068700, 3.68, 0.034400],
         [64 * 56 * 56 * 64, 64, 0.106200, 2.76, 0.050600],
         [64 * 56 * 56 * 64, 64, 0.148300, 2.76, 0.067700],
         [128 * 56 * 56 * 128, 128, 0.217300,3.68,0.101300],
         [128 * 28 * 28 * 128, 128, 0.249800,2.76,0.112900],
         [128 * 28 * 28 * 128, 128, 0.282900,2.76,0.126100],
         [128 * 14 * 14 * 128, 128, 0.325200,2.76,0.150100],
         [128 * 14 * 14 * 128, 128, 0.359900,2.76,0.167300],
         [128 * 28 * 28 * 128, 128, 0.390200,2.76,0.180400],
         [128 * 14 * 14 * 128, 128, 0.429200,2.76,0.200300],
         [128 * 14 * 14 * 128, 128, 0.462200,2.76,0.215900],
         [256 * 14 * 14 * 256, 128, 0.524000,3.68,0.240300],
         [256 * 14 * 14 * 256, 128, 0.569900,2.76,0.263800],
         [256 * 7 * 7 * 256, 64, 0.603500,2.76,0.278200],
         [256 * 7 * 7 * 256, 64, 0.639000,2.76,0.294200],
         [256 * 7 * 7 * 256, 64, 0.683100,2.76,0.313100],
         [256 * 7 * 7 * 256, 64, 0.716500,2.76,0.328600],
         [256 * 7 * 7 * 256, 64, 0.755500,2.76,0.349300],
         [256 * 7 * 7 * 256, 64, 0.792600,2.76,0.365600],
         [256 * 7 * 7 * 256, 64, 0.830200,2.76,0.382400],
         [256 * 7 * 7 * 256, 64, 0.863800,2.76,0.400600],
         [256 * 7 * 7 * 256, 64, 0.906200,2.76,0.428500],
         [256 * 7 * 7 * 256, 64, 0.948500,2.76,0.449400],
         [256 * 7 * 7 * 256, 64, 0.986300,2.76,0.470500],
         [256 * 7 * 7 * 256, 64, 1.023000,2.76,0.489200],
         [512 * 7 * 7 * 512, 128, 1.061500,2.76,0.507900],
         [512 * 7 * 7 * 512, 128, 1.104600,2.76,0.531700],
         [512 * 7 * 7 * 512, 128, 1.152300,2.76,0.561000],
         [512 * 7 * 7 * 512, 128, 1.185200,2.76,0.575600],
         [512 * 7 * 7 * 512, 128, 1.225700,2.76,0.595500],
         [512 * 7 * 7 * 512, 128, 1.256500,2.76,0.606900],
         [512 * 7 * 7 * 512, 128, 1.290900,2.76,0.624600],
         [512 * 7 * 7 * 512, 128, 1.336500,2.76,0.644100],
         [512 * 7 * 7 * 512, 128, 1.376900,2.76,0.660500],
         [512 * 7 * 7 * 512, 128, 1.418100,2.76,0.677500],
         [512 * 7 * 7 * 512, 128, 1.465800,2.76,0.699500],
         [512 * 7 * 7 * 512, 128, 1.498600,2.76,0.714700],
         [512 * 7 * 7 * 512, 128, 1.538000,2.76,0.732600],
         [512 * 7 * 7 * 512, 128, 1.575000,2.76,0.750700],
         [512 * 7 * 7 * 512, 128, 1.615300,2.76,0.767600],
         [512 * 7 * 7 * 512, 128, 1.652700,2.76,0.786200],
         [512 * 7 * 7 * 512, 128, 1.692300,2.76,0.808600],
         [512 * 7 * 7 * 512, 128, 1.733400,2.76,0.825400],
         [512 * 7 * 7 * 512, 128, 1.771200,2.76,0.842500],
         [512 * 7 * 7 * 512, 128, 1.804800,2.76,0.858400],
         [512 * 7 * 7 * 512, 128, 1.841000,2.76,0.875300],
         [512 * 7 * 7 * 512, 128, 1.878700,2.76,0.891700],
         [512 * 7 * 7 * 512, 128, 1.974000,3.68,0.933400],
         [512 * 7 * 7 * 512, 128, 2.040200,2.76,0.964000],
         [512 * 7 * 7 * 512, 128, 2.100500,2.76,0.994300],
         [0, 1, 2.101800,0.46,0.994600]],
        [[3 * 224 * 224 * 8, 1, 0, 0, 0],  # mobilenetv2
         [16 * 112 * 112 * 32, 32, 0.005392, 1.8811, 0.010143],
         [24 * 56 * 56 * 32, 48, 0.009008, 2.4805, 0.022344],
         [32 * 28 * 28 * 32, 32, 0.015418, 2.5565, 0.039416],
         [64 * 14 * 14 * 32, 32, 0.024955, 2.2014, 0.054936],
         [0, 1, 0.052676, 1.4797, 0.077945]]]


# head_time, tail_time, total_time, head_power, tail_power, data_size
dataG = [
    [0.13912029266357423, 0.17697544097900392, 0.31609573364257815, 24.424, 124.64, 3212444],
    [0.13784356117248536, 0.11342730522155761, 0.25127086639404295, 24.528, 124.982, 3212444],
    [0.1441175937652588, 0.10122289657592773, 0.24534049034118652, 24.838, 125.324, 3212444], 
    [0.10639810562133789, 0.07923331260681152, 0.1856314182281494, 24.628, 125.52, 1606812],  # 0.2410218
    [0.12051496505737305, 0.08070006370544433, 0.20121502876281738, 22.528, 125.682, 1606812], 
    [0.11761054992675782, 0.08239006996154785, 0.20000061988830567, 23.782, 125.844, 1606812], 
    [0.1266030788421631, 0.07109217643737793, 0.19769525527954102, 22.458, 126.138, 1606812], 
    [0.15807900428771973, 0.08326287269592285, 0.24134187698364257, 21.974, 126.264, 1606812], 
    [0.13420505523681642, 0.08232693672180176, 0.21653199195861816, 23.304000000000002, 126.334, 1606812], 
    [0.17487964630126954, 0.084075927734375, 0.2589555740356445, 20.939999999999998, 126.524, 1606812], 
    [0.21725692749023437, 0.07171516418457032, 0.2889720916748047, 21.742, 126.764, 1606812], 
    [0.2387545108795166, 0.05511975288391113, 0.29387426376342773, 17.584, 126.94800000000001, 803996], #0.1205109
    [0.24997644424438475, 0.05096006393432617, 0.3009365081787109, 18.244, 127.12, 803996], 
    [0.24942374229431152, 0.05156583786010742, 0.30098958015441896, 17.638, 127.426, 803996], 
    [0.24762744903564454, 0.049677705764770506, 0.29730515480041503, 18.054, 127.584, 803996], 
    [0.2516496181488037, 0.04988503456115723, 0.30153465270996094, 18.572, 127.558, 803996], 
    [0.289185905456543, 0.04826641082763672, 0.3374523162841797, 18.012, 127.64, 803996], 
    [0.30845026969909667, 0.0507469654083252, 0.35919723510742185, 18.07, 127.914, 803996], 
    [0.34880619049072265, 0.048720502853393556, 0.3975266933441162, 17.272, 128.082, 803996], 
    [0.3503432750701904, 0.04774489402770996, 0.3980881690979004, 17.314, 128.272, 803996], 
    [0.3466031551361084, 0.04985222816467285, 0.39645538330078123, 17.814, 128.29, 803996], 
    [0.34723124504089353, 0.05271787643432617, 0.3999491214752197, 18.066, 128.238, 803996], 
    [0.38803915977478026, 0.050197935104370116, 0.4382370948791504, 17.718, 128.444, 803996], 
    [0.4284190654754639, 0.05177793502807617, 0.48019700050354003, 17.514, 128.54600000000002, 803996], 
    [0.4322535514831543, 0.044996213912963864, 0.4772497653961182, 17.418, 128.63400000000001, 803996], 
    [0.44782004356384275, 0.04685177803039551, 0.4946718215942383, 17.830000000000002, 128.712, 803996], 
    [0.45545549392700196, 0.049280977249145506, 0.5047364711761475, 17.332, 128.92000000000002, 803996], 
    [0.4558736801147461, 0.042555952072143556, 0.4984296321868896, 17.736, 128.994, 803996], 
    [0.47423095703125, 0.04621944427490234, 0.5204504013061524, 17.46, 129.01, 803996], 
    [0.48942766189575193, 0.046211862564086915, 0.5356395244598389, 17.684, 129.258, 803996], 
    [0.5267928600311279, 0.047449684143066405, 0.5742425441741943, 17.314, 129.292, 803996], 
    [0.5364354133605957, 0.0423492431640625, 0.5787846565246582, 17.374, 129.52599999999998, 803996],
    [0.554266881942749, 0.04884071350097656, 0.6031075954437256, 17.381999999999998, 129.592, 803996], 
    [0.5537056446075439, 0.04182124137878418, 0.5955268859863281, 17.398, 129.626, 803996], 
    [0.554952335357666, 0.04719209671020508, 0.602144432067871, 17.586, 129.62800000000001, 803996], 
    [0.5698131561279297, 0.04677867889404297, 0.6165918350219727, 17.618, 129.628, 803996], 
    [0.610613489151001, 0.04374861717224121, 0.6543621063232422, 17.41, 129.762, 803996], 
    [0.6338605880737305, 0.04515881538391113, 0.6790194034576416, 17.13, 129.762, 803996], 
    [0.6539239406585693, 0.04625158309936524, 0.7001755237579346, 17.348, 129.712, 803996], 
    [0.6529238224029541, 0.045139741897583005, 0.6980635643005371, 17.372, 129.77, 803996], 
    [0.6556228637695313, 0.043819427490234375, 0.6994422912597656, 17.46, 129.806, 803996], 
    [0.7266360759735108, 0.047113037109375, 0.7737491130828857, 17.374, 129.686, 803996], 
    [0.7358827590942383, 0.049033832550048825, 0.7849165916442871, 17.36, 129.726, 803996], 
    [0.7311038017272949, 0.04471235275268555, 0.7758161544799804, 17.442, 129.766, 803996], 
    [0.75666823387146, 0.04330439567565918, 0.7999726295471191, 17.158, 129.892, 803996], 
    [0.7555070877075195, 0.039462947845458986, 0.7949700355529785, 17.418, 129.972, 803996], 
    [0.7643349647521973, 0.031071233749389648, 0.7954061985015869, 17.198, 129.85, 803996], 
    [0.7742961406707763, 0.02102046012878418, 0.7953166007995606, 17.342, 129.878, 402588], 
    [0.7993959426879883, 0.01870903968811035, 0.8181049823760986, 17.34, 129.966, 402588], 
    [0.8312005043029785, 0.011150312423706055, 0.8423508167266845, 17.426, 130.022, 402588]
]
def get_data(model, point):
    global data
    if model == 'vgg11':
        d = data[0]
    elif model == 'resnet18':
        d = data[1]
    elif model == 'resnet152':
        d = dataG
    elif model == 'mobilenetv2':
        d = data[3]
    else:
        raise NotImplementedError
    params = d[point]
    mid_data_size = params[5] / 4 * 3 / 4 * 8
    head_latency = params[0]
    tail_latency = params[1]
    head_power = params[3]
    tail_power = params[4]
    return mid_data_size, head_latency, head_power, tail_latency, tail_power
    # 量化之后的 base64 量化 bit
    data_size = params[5] / 4 * 3 / 4 * 8
    latency = params[2]
    power = params[3] + params[4]
    # energy = params[4]
    return data_size, latency, 0, power


if __name__ == '__main__':
    import numpy as np


    def compute_uplink_rate(power):
        # user should be added in occupying_users
        user_power = power / (50 ** 3)
        total_noise = 1e-9
        return 1e7 * np.log2(1 + (user_power / total_noise))


    power = 3
    for p in range(50):
        mid_data_size, head_latency, head_power, tail_latency, tail_power = get_data('resnet152', p)
        #print(data_size, latency)
        latency = head_latency + tail_latency
        energy = head_power * head_latency + tail_power * tail_latency
        time_offloading = mid_data_size / compute_uplink_rate(power)
        energy_offloading = time_offloading * power
        latency += time_offloading
        energy += energy_offloading
        print(f'point: {p}, time: {latency:.6f}s (offloading: {time_offloading:.6f}s), energy: {energy:.6f}j (offloading: {energy_offloading:.6f}j)')
